<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Epoch TxSign</title>
    <script src="https://unpkg.com/algosdk@latest"></script>
    <script src="./js/buffer.js"></script>
    <script src="./js/myalgo.js"></script>
    <script src ="./js/scripts.js"></script>

    <style>
        body{
            text-align: center;
            height: 100vh; /* Magic here */
                display: flex;
                justify-content: center;
                align-items: center;
        }
        .childDiv{
            border-width:1px;
            border-color: #4ABCD9;
            border-style: solid;
            width:70%;
            height:90%;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            /* justify-content: center; */
            align-items: center;
                }

            button{
                display:block;
                height:40px;
                width:200px;
                margin-top: 10px;
                border-radius: 10px;
                border-width: 0px;
                background-color: #4ABCD9;
                color: white;
                font-weight: bold;
            }
            .actionContainer{
                 width:100%;
                 text-align: center;
                 display: flex;
                 align-items:center ;
                 flex-direction: column;
                 margin-top: 30px;
            }
    </style>
</head>
<body>
    <div class="childDiv">

        <div class="actionContainer" id="connect">
            <button >Connect To myalgowallet</button>
        </div>
        <div class="actionContainer">
            <p id ="epochNftDesc1">Json Decription of transaction to Sign</p>
            <button id ="showEpochNft1Trans">Show NFT Edition 1 trans</button>
            <button id ="createEpochNft1">Create All 13 Editions</button>
            <button id ="clawbackAllAssets">Clawback All 13 Editions</button>
        </div>
        <!-- <div class="actionContainer">
            <p>Json Decription of transaction to Sign</p>
            <button id ="createEpochNft2">Create Epoch NFT Edition 2</button>
        </div>
        <button id ="createEpochNft2">Create Epoch NFT Edition 2</button> -->
    </div>

    <!-- <div>
        <button id="connect">Connect</button>
    </div>

    <div>
        <button id="optIn">Opt Into NFT</button>
    </div> -->
   
    

    <script>
        window.addEventListener('load',async function(){
        let epochNftDesc1 = document.getElementById("epochNftDesc1");
        let epochNftBut1 = document.getElementById("createEpochNft1");
        let showNft1but = document.getElementById("showEpochNft1Trans");
        let clawback13aAssetsBtn = document.getElementById("clawbackAllAssets")
        
        // let optInButton = document.getElementById("optIn");
        let connectButton = document.getElementById("connect");
      
        const token = { 'X-API-Key':'ADRySlL0NK5trzqZGAE3q1xxIqlQdSfk1nbHxTNe'};
        const server = "https://testnet-algorand.api.purestake.io/ps2";
        const baseServer = "https://testnet-algorand.api.purestake.io/idx2";
    
        const port = '';
        const client = new algosdk.Algodv2(token, server, port);
        let indexerClient = new algosdk.Indexer(token, baseServer, port);
        var compiledApprovalProgram = await compileFreeportContract(client);
        let compiledClearProgram = await compileClearProgram(client);
        let approvalProgram =  new Uint8Array(Buffer.from(compiledApprovalProgram.result,"base64"));
        let clearProgram =  new Uint8Array(Buffer.from(compiledClearProgram.result,"base64"));
        let params = await client.getTransactionParams().do();
        let allTransactions = [{txID: "A222A4KP27I5272R4CE4IFVJKMAFAIDCIOFETR5JYYAWHNEQC4QA", },
                                {txID:"RG3YDL57MQ5QQX6SU5HPCGHKBUQEHS4UBNZ3DH3YALRUOH4WQCFA"},
                                {txID:"M6OBWBIERL5A2LHB6HZWLURPD4YGHUDH57XKMQ47YB27VH4546UA"},
                                {txID: "WYECVTYHQSKG34DSHFSU3OAYTWMMF74SLVGH2KQUFAYE7XWSH2HA", },
                                {txID: "DPGOZFJF43QPZVIUPP3576FQJRQSK7IEXKNATA2TTDCYPNAZ2XCA", },
                                {txID: "JWDFRQ7FVYAIIPNVRJMPFKXMB6USUVV6VDWVVWQ4LDMYXO2XYUKQ", },
                                {txID: "OPGNCASNZAKK6E6D32TOECFFPVBW3UMZHWE6N5WASE2IH7ESSJSA", },
                                {txID: "ZBEGOZH7S7UMV4PSHQ6FLXWA5HOLHYBD7VPDQ2OF5JLPPYIXNPIQ", },
                                {txID: "BC34PXXZ5HVDMXZMMCU42EXEMKR4KSBTJ2MFQXDBEFFF45MKOMBQ", },
                                {txID: "V3R6JC7HW7YYJJZ3ARVMPJDLQHPG5FYHLEUBZ55OY336VOBKPWFA", },
                                {txID: "TW2DFZIRTU77KHX7TELL6TEHRZ3GXVJBCHYMN3PTU25I2BTOBQ5Q", },
                                {txID: "P7Y4VMC23DARVO5SERQXFTV2QXKVH6Q7LBVSE3XYCPCTR6H5IVJQ", },
                                {txID: "IYFRPSNMLBFCTUOOJDGVH4NLKQHFYZEC4A2D6OE55L63RMTRSL3Q", },
                                {txID: "7KPXDCO33J4OUHRRE4VXTPL6ZUFT75ZM6ILZFBLI3GVNEDUGQE3Q", }];
        let appId =0;
        console.log(approvalProgram);
        let allAssetIds = [];
        console.log(clearProgram);
      
      
        let sender = "FNYZLBWJTCIMWKZCE4Q6JHQHLD3XHGVDZTD5YXRYVR4CDKZY2NHG7RA65I";
        // console.log(createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender))
        connectButton.addEventListener('click',async function(){
           let addresses = await  myalgoConnect.connect();
            sender = addresses[0].address;
            console.log(sender);
        });
        let epochtx1 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx2 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx3 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx4 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx5 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx6 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx7 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx8 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx9 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx10 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx11 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx12 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
        // let epochtx13 = createEpochNft("name",params,approvalProgram,clearProgram,1000000,sender);
         
        epochNftBut1.addEventListener('click',async function(){       // alert("epochNft1");
            let confirmedTx = await createAssetTxn([...epochtx1]);
            // txID
        });

        clawback13aAssetsBtn.addEventListener('click',async function(){
            console.log("clicked");
            for (let i =0;i<allTransactions.length;i++){
                if(i!=1){
                        let txId = allTransactions[i].txID;
                        let transactionInfo =  await getTransactionInfo(txId)
                        let assetId = transactionInfo.transaction["created-asset-index"];
                        allAssetIds.push(assetId);
                    }else{
                        let txId = allTransactions[i].txID;
                        let transactionInfo =  await getTransactionInfo(txId)
                        appId = transactionInfo.transaction["created-application-index"];
                    }
            }

            console.log(allAssetIds);
            console.log(appId)
            let assetClawbackAddress = {};
            try{
                assetClawbackAddress = await compileEpochClawbackAddress(appId,client);
            }catch(error){
                console.error(error)
                alert(error);  
            }
            let params ={};
                try{
                params = await client.getTransactionParams().do();
                }catch(error){
                    console.error(error)
                alert(error); 
                }
            let allAssetClawBackTxns = allAssetIds.map((el)=>{
                return updateAsa(params,sender,el,sender,sender,sender,assetClawbackAddress)
            });
            console.log(allAssetClawBackTxns);
            let confirmedTx = await createAssetTxn([...allAssetClawBackTxns]);
            // txID
  
        })
 

       async function getTransactionInfo(txId){
        let transactionInfo = {};
            return new Promise(async(resolve,reject)=>{
                setTimeout(async function(){
                    try{
                transactionInfo =  await indexerClient.lookupTransactionByID(txId).do()
                let assetId = transactionInfo.transaction["created-asset-index"];
                resolve(transactionInfo);
                }catch(error){
                reject(error);
                }
                },1000)
               
               
            })
      
            return 
        }




        // optInButton.addEventListener('click',async function(){
        //     let addressToOptInto = await optInEpochNft(sender,16405423);
        //     console.log(addressToOptInto);
        // });


        async function createAssetTxn(epochTx){

return new Promise(async(resolve,reject)=>{
   
 
    let epoch1Str = JSON.stringify(epochTx);
      let signedTxns = {}
      try{
        signedTxns =   await  myalgoConnect.signTransaction(epochTx);
        allTransactions = signedTxns;
      }catch(error){
        reject(error);
      }
      console.log(signedTxns);
      let blobs = signedTxns.map((el,index)=>{
              return el.blob
          });
    try{
     let   txTest={}
     try{ 
         txTest = (await client.sendRawTransaction(blobs).do());
         console.log(txTest);
         resolve(txTest)
     }catch(error){
         reject(error)
     }
      }catch(error){
        console.error("Error ocurred ", error);
        
                reject(error);
                return;
        }

});

}


        function formatJson(jsonString){
            f = {
            brace: 0
        }; // AN OBJECT FOR TRACKING INCREMENTS/DECREMENTS,
           // IN PARTICULAR CURLY BRACES (OTHER PROPERTIES COULD BE ADDED)
     

            let regstr = jsonString.replace(/({|}[,]*|[^{}:]+:[^{}:,]*[,{]*)/g, function (m, p1) {
                            var rtnFn = function() {
                                    return '<div style="text-indent: ' + (f['brace'] * 20) + 'px;">' + p1 + '</div>';
                                },
                                rtnStr = 0;
                                if (p1.lastIndexOf('{') === (p1.length - 1)) {
                                    rtnStr = rtnFn();
                                    f['brace'] += 1;
                                } else if (p1.indexOf('}') === 0) {
                                    f['brace'] -= 1;
                                    rtnStr = rtnFn();
                                } else {
                                    rtnStr = rtnFn();
                                }
                                return rtnStr;
                            });
            return regstr;
        }
        });

       







      
          /*
          Peter Conects to myalgoconnect
          He creates the assets editions 1 to 13 of his asset
          He claws back each asset just immediately after creating them

          
          */
    </script>

  
</body>
</html>